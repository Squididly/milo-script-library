{func
   sky_great
   {if
      {< $arena.old_excitement kExcitementGreat}
      {arena
         switch_anim
         clouds.matanim
         (range 3 3)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         sunbeam.matanim
         (range 1 1)
         (scale 1)
         (blend 960)}
      {arena
         switch_anim
         roof_top.matanim
         (range 0 0)
         (scale 1)
         (blend
            {level dtime_to_dtick 2800})}
      {arena
         switch_anim
         rain.partanim
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 2800})}
      {arena
         switch_anim
         sun01.tnm
         (range 3 3)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         Sun01.litanim
         (range 3 3)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         venue.envanim
         (range 3 3)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         siren_blue.matanim
         (loop 0 1920)
         (scale 1)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         siren_red.matanim
         (loop 0 1920)
         (scale 1)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         siren_blue_glow.matanim
         (loop 0 1920)
         (scale 1)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         siren_red_glow.matanim
         (loop 0 1920)
         (scale 1)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         police_barrier_flash.matanim
         (loop 0 1920)
         (scale 1)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         windows_A.matanim
         (loop 0 1920)
         (scale 1)
         (blend 0)}
      {arena
         switch_anim
         windows_B.matanim
         (loop 0 1920)
         (scale 1)
         (blend 0)}
      {arena
         blend_to_frame
         helicopter_metatrans.tnm
         1000
         2800
         (severity 5)}
      {sky_sphere2.mesh set_showing TRUE}
      {police_firetruck_draw.view set_showing TRUE}
      {lenseflare_block.mesh set_showing FALSE}
      {lense_flare.fla set_showing TRUE}
      {puddle_group1.view set_showing FALSE}
      {puddle_group2.view set_showing FALSE}
      {puddle_group3.view set_showing FALSE}
      {puddle_group4.view set_showing FALSE}
      {puddle_group5.view set_showing FALSE}
      {roof_highlights.view set_showing TRUE}
      {arena
         switch_anim
         color_plane.matanim
         (range 3 3)
         (scale 1)
         (blend 0)}}}
{func
   sky_okay
   {if
      {!= $arena.old_excitement kExcitementOkay}
      {arena
         switch_anim
         clouds.matanim
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         shadows.matanim
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         sun01.tnm
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         roof_top.matanim
         (range 0 0)
         (scale 1)
         (blend
            {level dtime_to_dtick 2800})}
      {sky_sphere2.mesh set_showing TRUE}
      {police_firetruck_draw.view set_showing TRUE}
      {lenseflare_block.mesh set_showing FALSE}
      {lense_flare.fla set_showing TRUE}
      {arena
         switch_anim
         rain.partanim
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 2800})}
      {arena
         switch_anim
         siren_blue.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         Sun01.litanim
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         venue.envanim
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         siren_red.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         siren_blue_glow.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         siren_red_glow.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         police_barrier_flash.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         windows_A.matanim
         (range 0 0)
         (scale 1)
         (blend 0)}
      {arena
         switch_anim
         windows_B.matanim
         (range 0 0)
         (scale 1)
         (blend 0)}
      {arena
         blend_to_frame
         helicopter_metatrans.tnm
         0
         2800
         (severity 5)}
      {arena
         switch_anim
         color_plane.matanim
         (range 2 2)
         (scale 1)
         (blend 0)}
      {arena
         switch_anim
         sunbeam.matanim
         (range 0 0)
         (scale 1)
         (blend 960)}
      {puddle_group1.view set_showing FALSE}
      {puddle_group2.view set_showing FALSE}
      {puddle_group3.view set_showing FALSE}
      {puddle_group4.view set_showing FALSE}
      {puddle_group5.view set_showing FALSE}
      {roof_highlights.view set_showing FALSE}}}
{func
   sky_bad
   {arena
      switch_anim
      clouds.matanim
      (range 1 1)
      (scale 1)
      (blend
         {level dtime_to_dtick 1400})}
   {arena
      switch_anim
      sunbeam.matanim
      (range 0 0)
      (scale 1)
      (blend 960)}
   {arena
      switch_anim
      roof_top.matanim
      (range 1 1)
      (scale 1)
      (blend
         {level dtime_to_dtick 2800})}
   {arena
      switch_anim
      shadows.matanim
      (range 1 1)
      (scale 1)
      (blend
         {level dtime_to_dtick 1400})}
   {arena
      switch_anim
      rain.partanim
      (range 1 1)
      (scale 1)
      (blend
         {level dtime_to_dtick 2800})}
   {arena
      switch_anim
      siren_blue.matanim
      (range 20000 20000)
      (scale 1)
      (blend
         {level dtime_to_dtick 120})}
   {arena
      switch_anim
      siren_red.matanim
      (range 20000 20000)
      (scale 1)
      (blend
         {level dtime_to_dtick 120})}
   {arena
      switch_anim
      siren_blue_glow.matanim
      (range 20000 20000)
      (scale 1)
      (blend
         {level dtime_to_dtick 120})}
   {arena
      switch_anim
      siren_red_glow.matanim
      (range 20000 20000)
      (scale 1)
      (blend
         {level dtime_to_dtick 120})}
   {arena
      switch_anim
      police_barrier_flash.matanim
      (range 20000 20000)
      (scale 1)
      (blend
         {level dtime_to_dtick 120})}
   {arena
      switch_anim
      windows_A.matanim
      (range 960 960)
      (scale 1)
      (blend 0)}
   {arena
      switch_anim
      windows_B.matanim
      (range 0 0)
      (scale 1)
      (blend 0)}
   {arena
      switch_anim
      color_plane.matanim
      (loop 10000 16000)
      (scale 1)
      (blend 0)}
   {arena
      switch_anim
      venue.envanim
      (range 1 1)
      (scale 1)
      (blend
         {level dtime_to_dtick 1400})}
   {lightning}
   {arena
      blend_to_frame
      helicopter_metatrans.tnm
      0
      2800
      (severity 5)}
   {police_firetruck_draw.view set_showing FALSE}
   {lenseflare_block.mesh set_showing TRUE}
   {lense_flare.fla set_showing FALSE}
   {puddle_group1.view set_showing TRUE}
   {puddle_group2.view set_showing TRUE}
   {puddle_group3.view set_showing TRUE}
   {puddle_group4.view set_showing TRUE}
   {puddle_group5.view set_showing TRUE}
   {roof_highlights.view set_showing FALSE}}
{func
   lightning
   {if
      {== $arena.excitement kExcitementBad}
      {arena
         switch_anim
         lightning_base.matanim
         (range 0 480)
         (scale 1)
         (blend 0)}
      {arena
         switch_anim
         lightning_glow.matanim
         (range 0 480)
         (scale 1)
         (blend 0)}
      {arena
         switch_anim
         Sun01.litanim
         (range 1000 1180)
         (scale 1)
         (blend 0)}
      {arena
         switch_anim
         sun01.tnm
         (range 1000 1280)
         (scale 1)
         (blend 0)}
      {arena
         delay_task
         240
         {play_sfx
            {sprintf
               "thunder%i"
               {random_int 1 3}}
            (stop TRUE)
            (volume
               {'*'
                  {the_db get_sfx_volume}
                  {random_float 0.7 1.0}})
            (transpose
               {random_float -2.0 2.0})}}
      {arena
         delay_task
         {random_int 15000 35000}
         {lightning}}}}
{arena
   add_handlers
   (init
      {play_sfx
         "hornloop"
         (volume
            {the_db get_sfx_volume})}
      {if
         {!
            {the_db is_practice_mode}}
         {play_sfx
            "goodloop"
            (volume
               {the_db get_sfx_volume})}}
      {venue.view remove_anim clouds.matanim}
      {venue.view remove_anim venue.envanim}
      {venue.view remove_anim sunbeam.matanim}
      {venue.view remove_anim sun01.tnm}
      {venue.view remove_anim Sun01.litanim}
      {venue.view remove_anim police_barrier_flash.matanim}
      {venue.view remove_anim siren_blue.matanim}
      {venue.view remove_anim siren_red.matanim}
      {venue.view remove_anim siren_blue_glow.matanim}
      {venue.view remove_anim siren_red_glow.matanim}
      {venue.view remove_anim color_plane.matanim}
      {venue.view remove_anim windows_A.matanim}
      {venue.view remove_anim windows_B.matanim}
      {venue.view remove_anim lightning_base.matanim}
      {venue.view remove_anim lightning_glow.matanim}
      {venue.view remove_anim roof_top.matanim}
      {venue.view remove_anim shadows.matanim}
      {venue.view remove_anim rain.partanim}
      {venue.view remove_anim helicopter_metatrans.tnm}
      {venue.view remove_anim balloons_green.partanim}
      {venue.view remove_anim balloons_yellow.partanim}
      {venue.view remove_anim balloons_red.partanim}
      {sky_news.view set_showing FALSE}
      {puddle_group1.view set_showing FALSE}
      {puddle_group2.view set_showing FALSE}
      {puddle_group3.view set_showing FALSE}
      {puddle_group4.view set_showing FALSE}
      {puddle_group5.view set_showing FALSE}
      {roof_highlights.view set_showing FALSE}
      {balloons_green.partanim set_frame 0}
      {balloons_red.partanim set_frame 0}
      {balloons_yellow.partanim set_frame 0}
      {helicopter_metatrans.tnm set_frame 0}
      {roof_top.matanim set_frame 0}
      {sunbeam.matanim set_frame 0}
      {venue.envanim set_frame 2}
      {sky_sphere2.mesh set_showing TRUE}
      {police_firetruck_draw.view set_showing TRUE}
      {lenseflare_block.mesh set_showing FALSE}
      {lightning_base.matanim set_frame 0}
      {lightning_glow.matanim set_frame 0}
      {color_plane.matanim set_frame 0}
      {set $rooftop.last_firework_tick -10000.0}
      {arena
         switch_anim
         clouds.matanim
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         sun01.tnm
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         rain.partanim
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 2800})}
      {arena
         switch_anim
         siren_blue.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         Sun01.litanim
         (range 2 2)
         (scale 1)
         (blend
            {level dtime_to_dtick 1400})}
      {arena
         switch_anim
         siren_red.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         siren_blue_glow.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         siren_red_glow.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         police_barrier_flash.matanim
         (loop 0 1920)
         (scale 0.5)
         (blend
            {level dtime_to_dtick 120})}
      {arena
         switch_anim
         windows_A.matanim
         (range 0 0)
         (scale 1)
         (blend 0)}
      {arena
         switch_anim
         windows_B.matanim
         (range 0 0)
         (scale 1)
         (blend 0)}
      {arena
         blend_to_frame
         helicopter_metatrans.tnm
         0
         3800
         (severity 3)})
   (terminate
      {stop_sfx
         "hornloop"}
      {stop_sfx
         "goodloop"}
      {delete sky_great}
      {delete sky_okay}
      {delete sky_bad}
      {delete lightning})
   (intro_end
      {stop_sfx
         "hornloop"}
      {stop_sfx
         "goodloop"})
   (venue_ok
      {sky_okay})
   (venue_bad
      {sky_bad})
   (venue_great
      {sky_great})
   (venue_boot
      {sky_bad})
   (venue_switch_cam
      {if_else
         {&&
            {== $arena.excitement kExcitementGreat}
            {'||'
               {==
                  {arena cam_msg}
                  "Chopper_Cam"}
               {==
                  {arena cam_msg}
                  "Crowd 5"}}
            {!
               {the_db is_practice_mode}}}
         {sky_news.view set_showing TRUE}
         {sky_news.view set_showing FALSE}}
      {if_else
         {==
            {arena cam_msg}
            "Win"}
         {lense_flare.fla set_showing FALSE}
         {lense_flare.fla set_showing TRUE}}
      {if_else
         {&&
            {>= $arena.excitement kExcitementOkay}
            {'||'
               {==
                  {arena cam_msg}
                  "Right char 10"}
               {==
                  {arena cam_msg}
                  "Begin"}
               {==
                  {arena cam_msg}
                  "Right char 0"}
               {==
                  {arena cam_msg}
                  "Right char 1"}
               {==
                  {arena cam_msg}
                  "Right char 3"}
               {==
                  {arena cam_msg}
                  "Right char 5"}
               {==
                  {arena cam_msg}
                  "Right char 0"}
               {==
                  {arena cam_msg}
                  "Stage 6"}
               {==
                  {arena cam_msg}
                  "superhigh3"}
               {==
                  {arena cam_msg}
                  "crowd_roof"}}}
         {sunbeams.view set_showing FALSE}
         {sunbeams.view set_showing TRUE}}
      {if
         {&&
            {>= $arena.excitement kExcitementGreat}
            {>=
               {- $db.music_tick $rooftop.last_firework_tick}
               5760.0}
            {==
               {arena cam_msg}
               "Win"}}
         {set $rooftop.last_firework_tick $db.music_tick}
         {arena
            launch_fireworks
            (start 1 1 0.2 1)
            (end 0.2 1 1 0)}
         {arena
            launch_fireworks
            (start 0.2 1 0.2 1)
            (end 0.2 0.2 1 0)}
         {balloons_green.partanim set_frame 1}
         {balloons_red.partanim set_frame 1}
         {balloons_yellow.partanim set_frame 1}
         {arena
            delay_task
            480
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 2.0 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 0.2 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 2.0 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 0.2 0.2 1 0)}}
         {arena
            delay_task
            960
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 2.0 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 0.2 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 2.0 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 0.2 0.2 1 0)}}
         {arena
            delay_task
            1440
            {arena
               launch_fireworks
               (start 1 0.2 0.2 1)
               (end 1 0.4 1 0)}
            {arena
               launch_fireworks
               (start 1 0.4 1 1)
               (end 0.2 0.2 1 0)}
            {arena
               launch_fireworks
               (start 1 0.2 0.2 1)
               (end 1 0.4 1 0)}
            {arena
               launch_fireworks
               (start 1 0.4 1 1)
               (end 0.2 0.2 1 0)}}})
   (venue_bonus
      {if
         {&&
            {>= $arena.excitement kExcitementGreat}
            {>=
               {- $db.music_tick $rooftop.last_firework_tick}
               5760.0}}
         {set $rooftop.last_firework_tick $db.music_tick}
         {arena
            launch_fireworks
            (start 1 1 0.2 1)
            (end 0.2 1 1 0)}
         {arena
            launch_fireworks
            (start 0.2 1 0.2 1)
            (end 0.2 0.2 1 0)}
         {balloons_green.partanim set_frame 1}
         {balloons_red.partanim set_frame 1}
         {balloons_yellow.partanim set_frame 1}
         {arena
            delay_task
            480
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 2.0 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 0.2 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 2.0 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 0.2 0.2 1 0)}}
         {arena
            delay_task
            960
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 2.0 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 0.2 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 2.0 0.2 1 0)}
            {arena
               launch_fireworks
               (start 0.2 1 0.2 1)
               (end 0.2 0.2 1 0)}}
         {arena
            delay_task
            1440
            {arena
               launch_fireworks
               (start 1 0.2 0.2 1)
               (end 1 0.4 1 0)}
            {arena
               launch_fireworks
               (start 1 0.4 1 1)
               (end 0.2 0.2 1 0)}
            {arena
               launch_fireworks
               (start 1 0.2 0.2 1)
               (end 1 0.4 1 0)}
            {arena
               launch_fireworks
               (start 1 0.4 1 1)
               (end 0.2 0.2 1 0)}
            {balloons_green.partanim set_frame 0}
            {balloons_red.partanim set_frame 0}
            {balloons_yellow.partanim set_frame 0}}})
   (venue_enter_blur
      {lense_flare.fla set_showing FALSE}
      {print
         "entering blur - turn off lense flare\n"})
   (venue_exit_blur
      {lense_flare.fla set_showing TRUE}
      {print
         "exiting blur - turn {on} lense flare\n"})}