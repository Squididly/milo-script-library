{new_kb_panel
   keyboard
   (fade_mats TRUE)
   (enter
      {keyboard_help54.mesh
         set_mat
         {platform button_mat kb_enter}}
      {keyboard_help67.mesh
         set_mat
         {platform button_mat kb_space}}
      {keyboard_help27.mesh
         set_mat
         {platform button_mat kb_back}}
      {keyboard_help55.mesh
         set_mat
         {platform button_mat kb_shift}}
      {keyboard_help66.mesh
         set_mat
         {platform button_mat kb_shift}})
   (finish_load
      {new_style
         button_style_kb_entry
         (normal
            "keyboard_entry.mat"
            "axaxax.font")
         (focused
            "keyboard_entry.mat"
            "axaxax.font")
         (disabled
            "keyboard_entry.mat"
            "axaxax.font")}
      {new_style
         key_small_style
         (normal
            "keyboard_small_normal.mat"
            "axaxax.font")
         (focused
            "keyboard_small_focused.mat"
            "axaxax.font")
         (disabled
            "keyboard_small_normal.mat"
            "axaxax.font")}
      {new_style
         key_big_style
         (normal
            "keyboard_big_normal.mat"
            "axaxax.font")
         (focused
            "keyboard_big_focused.mat"
            "axaxax.font")
         (disabled
            "keyboard_big_normal.mat"
            "axaxax.font")}
      {new_style
         key_high_style
         (normal
            "keyboard_high_normal.mat"
            "axaxax.font")
         (focused
            "keyboard_high_focused.mat"
            "axaxax.font")
         (disabled
            "keyboard_high_normal.mat"
            "axaxax.font")}
      {new_style
         key_low_style
         (normal
            "keyboard_low_normal.mat"
            "axaxax.font")
         (focused
            "keyboard_low_focused.mat"
            "axaxax.font")
         (disabled
            "keyboard_low_normal.mat"
            "axaxax.font")}
      {new_text_entry
         01
         (hilight_style button_style_kb_entry)}
      {new_kb_key
         but_01
         key_small_style
         (rnd_name
            "14")}
      {new_kb_key
         but_02
         key_small_style
         (rnd_name
            "15")}
      {new_kb_key
         but_03
         key_small_style
         (rnd_name
            "16")}
      {new_kb_key
         but_04
         key_small_style
         (rnd_name
            "17")}
      {new_kb_key
         but_05
         key_small_style
         (rnd_name
            "18")}
      {new_kb_key
         but_06
         key_small_style
         (rnd_name
            "19")}
      {new_kb_key
         but_07
         key_small_style
         (rnd_name
            "20")}
      {new_kb_key
         but_08
         key_small_style
         (rnd_name
            "21")}
      {new_kb_key
         but_09
         key_small_style
         (rnd_name
            "22")}
      {new_kb_key
         but_10
         key_small_style
         (rnd_name
            "23")}
      {new_kb_key
         but_11
         key_small_style
         (rnd_name
            "24")}
      {new_kb_key
         but_12
         key_small_style
         (rnd_name
            "25")}
      {new_kb_key
         but_13
         key_small_style
         (rnd_name
            "26")}
      {new_kb_key
         but_back
         key_big_style
         (rnd_name
            "27")}
      {new_kb_key
         but_14
         key_small_style
         (rnd_name
            "29")}
      {new_kb_key
         but_15
         key_small_style
         (rnd_name
            "30")}
      {new_kb_key
         but_16
         key_small_style
         (rnd_name
            "31")}
      {new_kb_key
         but_17
         key_small_style
         (rnd_name
            "32")}
      {new_kb_key
         but_18
         key_small_style
         (rnd_name
            "33")}
      {new_kb_key
         but_19
         key_small_style
         (rnd_name
            "34")}
      {new_kb_key
         but_20
         key_small_style
         (rnd_name
            "35")}
      {new_kb_key
         but_21
         key_small_style
         (rnd_name
            "36")}
      {new_kb_key
         but_22
         key_small_style
         (rnd_name
            "37")}
      {new_kb_key
         but_23
         key_small_style
         (rnd_name
            "38")}
      {new_kb_key
         but_24
         key_small_style
         (rnd_name
            "39")}
      {new_kb_key
         but_25
         key_small_style
         (rnd_name
            "40")}
      {new_kb_key
         but_26
         key_small_style
         (rnd_name
            "41")}
      {new_kb_key
         but_caps
         key_low_style
         (rnd_name
            "42")}
      {new_kb_key
         but_28
         key_small_style
         (rnd_name
            "43")}
      {new_kb_key
         but_29
         key_small_style
         (rnd_name
            "44")}
      {new_kb_key
         but_30
         key_small_style
         (rnd_name
            "45")}
      {new_kb_key
         but_31
         key_small_style
         (rnd_name
            "46")}
      {new_kb_key
         but_32
         key_small_style
         (rnd_name
            "47")}
      {new_kb_key
         but_33
         key_small_style
         (rnd_name
            "48")}
      {new_kb_key
         but_34
         key_small_style
         (rnd_name
            "49")}
      {new_kb_key
         but_35
         key_small_style
         (rnd_name
            "50")}
      {new_kb_key
         but_36
         key_small_style
         (rnd_name
            "51")}
      {new_kb_key
         but_37
         key_small_style
         (rnd_name
            "52")}
      {new_kb_key
         but_38
         key_small_style
         (rnd_name
            "53")}
      {new_kb_key
         but_enter
         key_big_style
         (rnd_name
            "54")}
      {new_kb_key
         but_lshift
         key_low_style
         (rnd_name
            "55")}
      {new_kb_key
         but_41
         key_small_style
         (rnd_name
            "56")}
      {new_kb_key
         but_42
         key_small_style
         (rnd_name
            "57")}
      {new_kb_key
         but_43
         key_small_style
         (rnd_name
            "58")}
      {new_kb_key
         but_44
         key_small_style
         (rnd_name
            "59")}
      {new_kb_key
         but_45
         key_small_style
         (rnd_name
            "60")}
      {new_kb_key
         but_46
         key_small_style
         (rnd_name
            "61")}
      {new_kb_key
         but_47
         key_small_style
         (rnd_name
            "62")}
      {new_kb_key
         but_48
         key_small_style
         (rnd_name
            "63")}
      {new_kb_key
         but_49
         key_small_style
         (rnd_name
            "64")}
      {new_kb_key
         but_50
         key_small_style
         (rnd_name
            "65")}
      {new_kb_key
         but_rshift
         key_low_style
         (rnd_name
            "66")}
      {new_kb_key
         but_space
         key_big_style
         (rnd_name
            "67")}
      {new_kb_key
         but_larrow
         key_small_style
         (rnd_name
            "68")}
      {new_kb_key
         but_rarrow
         key_small_style
         (rnd_name
            "69")}
      {new_kb_key
         but_del
         key_big_style
         (rnd_name
            "70")})
   (navigator
      (horizontal but_01 but_02 but_03 but_04 but_05 but_06 but_07 but_08 but_09 but_10 but_11 but_12 but_13 but_back)
      (horizontal but_14 but_15 but_16 but_17 but_18 but_19 but_20 but_21 but_22 but_23 but_24 but_25 but_26)
      (horizontal but_caps but_28 but_29 but_30 but_31 but_32 but_33 but_34 but_35 but_36 but_37 but_38 but_enter)
      (horizontal but_lshift but_41 but_42 but_43 but_44 but_45 but_46 but_47 but_48 but_49 but_50 but_rshift)
      (horizontal but_space but_larrow but_rarrow but_del)
      (vertical but_01 but_caps but_lshift)
      (vertical but_02 but_14 but_caps but_lshift but_space)
      (vertical but_03 but_15 but_28 but_lshift but_space)
      (vertical but_04 but_16 but_29 but_41 but_space)
      (vertical but_05 but_17 but_30 but_42 but_space)
      (vertical but_06 but_18 but_31 but_43 but_space)
      (vertical but_07 but_19 but_32 but_44 but_space)
      (vertical but_08 but_20 but_33 but_45 but_space)
      (vertical but_09 but_21 but_34 but_46 but_space)
      (vertical but_10 but_22 but_35 but_47 but_space)
      (vertical but_11 but_23 but_36 but_48 but_space)
      (vertical but_12 but_24 but_37 but_49 but_larrow)
      (vertical but_13 but_25 but_38 but_50 but_rarrow)
      (vertical but_back but_26 but_enter but_rshift but_del)
      (vertical but_back but_25 but_enter but_rshift but_del)
      (vertical but_back but_26 but_enter but_rshift))}
#define KEYBOARD_SCREEN_HANDLERS
((panels bg status keyboard)
   (focus keyboard)
   (char none)
   (status
      (default
         ((button back)
            (text back)
            (button select)
            (text select_key)))))
{new_kr_screen
   keyboard_user
   KEYBOARD_SCREEN_HANDLERS
   (enter_keyboard_user
      ($username_button $player $username_provider)
      {if_else
         {'||'
            {$username_button selected_pos}
            {the_db has_free_users}}
         {do
            {{ui panel keyboard}
               set_text
               {if_else
                  {$username_button selected_pos}
                  {$username_button get_text}
                  ""}}
            {$this set player $player}
            {$this set username_provider $username_provider}
            {$this
               set
               return_screen
               {ui current_screen}}
            {ui goto_screen $this}}
         {do
            {ui push_screen error_usernames_full}}})
   (enter
      {if_else
         {the_db
            get_user_index
            {$this get player}
            {$this get username_provider}}
         {keyboard_rollout.roll set_text edit_user}
         {keyboard_rollout.roll set_text create_user}})
   (SELECT_MSG
      {if
         {== $component but_enter}
         {do
            (($new_name
                  {{ui panel keyboard}
                     get_text}))
            {if_else
               {==
                  $new_name
                  ""}
               {ui push_screen error_no_username}
               {if_else
                  {the_db
                     get_user_index
                     {$this get player}
                     {$this get username_provider}}
                  {if_else
                     {the_db
                        set_user_name
                        {$this get player}
                        $new_name}
                     {autosave_point
                        {$this get return_screen}}
                     {ui push_screen error_duplicate_username}}
                  {if_else
                     {the_db
                        add_user
                        {$this get player}
                        $new_name}
                     {autosave_point
                        {$this get return_screen}}
                     {ui push_screen error_duplicate_username}}}}}})
   (BUTTON_DOWN_MSG
      {if
         {platform is_button back $button}
         {go_back
            {$this get return_screen}}})}
{new_kr_screen
   keyboard_char
   KEYBOARD_SCREEN_HANDLERS
   (enter_keyboard_char
      ($saved_screen)
      {{ui panel keyboard}
         set_text
         {char_model_mgr edit_name}}
      {$this set saved_screen $saved_screen}
      {$this
         set
         return_screen
         {ui current_screen}}
      {ui goto_screen $this})
   (enter
      {keyboard_rollout.roll set_text enter_char_name})
   (SELECT_MSG
      {if
         {== $component but_enter}
         {do
            (($char_name
                  {{ui panel keyboard}
                     get_text}))
            {cond
               ({==
                     $char_name
                     ""}
                  {ui push_screen error_no_char_name})
               ({char_model_mgr is_char_name_taken $char_name}
                  {ui push_screen error_duplicate_char_name})
               (TRUE
                  {char_model_mgr
                     save_edit
                     $char_name
                     {$this get saved_screen}
                     {ui screen error_chars_full}})}}})
   (BUTTON_DOWN_MSG
      {if
         {platform is_button back $button}
         {go_back
            {$this get return_screen}}})}